{% extends "default.html" %}

{% block title %}
	<title>Chat</title>
	<meta name="description" content="Chat">
{% endblock %}

{% block content %}

<div class="border-right py-3 px-3">
	<span data-toggle="tooltip" data-placement="bottom" data-bs-title="Users online right now" title="Users online right now" class="text-muted">
		<i class="far fa-user fa-sm mr-1"></i>
		<span class="board-chat-count">0</span>
	</span>
</div>

<div id="chat-line-template" class="d-none">
	<div class="chat-line my-2">
		<div class="d-flex align-items-center">
			<span class="rounded mb-auto d-none d-md-block chat-profile">
				<img class="desktop-avatar rounded-circle w-100">
			</span>
			<div class="pl-md-3 text-muted">
				<div>
					<img class="mobile-avatar profile-pic-30 mr-1 d-inline-block d-md-none" data-toggle="tooltip" data-placement="right">
					<a href="" class="font-weight-bold text-black userlink" target="_blank"></a>
					<div style="overflow:hidden">
						<span class="chat-message text-black text-break"></span>
						<button class="quote-btn btn d-inline-block pt-0"><i class="fas fa-reply" aria-hidden="true"></i></button>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="container py-0 chat-container">
	<div id="chat-window">
		<div id="chat-text" class="fullchat">
			{% for m in messages %}
				<div class="chat-line my-2">
					<div class="d-flex align-items-center">
						<span class="rounded mb-auto d-none d-md-block chat-profile">
							<img class="desktop-avatar rounded-circle w-100" src="{{m['avatar']}}">
						</span>
						<div class="pl-md-3 text-muted">
							<div>
								<img src="{{m['avatar']}}" class="mobile-avatar profile-pic-30 mr-1 d-inline-block d-md-none" data-toggle="tooltip" data-placement="right">
								<a class="font-weight-bold text-black userlink" style="color:#{{m['namecolor']}}" target="_blank" href="/@{{m['username']}}">{{m['username']}}</a>
								<div style="overflow:hidden">
									<span class="chat-message text-black text-break">{{m['text_html'] | safe}}</span>
									{% set text=m['text'] %}
									<button class="btn d-inline-block pt-0"><i onclick="quote('{{text}}')" class="fas fa-reply" aria-hidden="true"></i></button>
								</div>
							</div>
						</div>
					</div>
				</div>		
			{% endfor %}
		</div>
		<div id="system-template">
			<div class="system-line">
				<p class="message text-muted"></p>
			</div>
		</div>
	</div>
	<div class="position-relative form-group d-flex pb-3">
		<div class="position-absolute text-muted text-small" style="bottom: -1.5rem; line-height: 1;">
			<span id="typing-indicator"></span>
			<span id="loading-indicator" class="d-none"></span>
		</div>
		<i class="btn btn-secondary mr-2 fas fa-smile-beam" style="padding-top:0.65rem" onclick="loadEmojis('input-text')" aria-hidden="true" data-bs-toggle="modal" data-bs-target="#emojiModal" data-bs-placement="bottom" title="Add Emoji"></i>
		<textarea id="input-text" minlength="1" maxlength="1000" type="text" class="form-control" placeholder="Message" autocomplete="off" autofocus rows="1"></textarea>
		<button id="chatsend" onclick="send()" class="btn btn-primary ml-3" type="submit">Send</button>
	</div>
</div>

<script src="/assets/js/socketio.js"></script>

<style>
	#chat-window {
		max-height:calc(100vh - 300px);
		overflow-y: scroll;
	}

	.fullchat .chat-profile {
		min-width: 42px;
		width: 42px;
		height: 42px;
	}

	#chat-window::-webkit-scrollbar {
		display: none;
	}

	#chat-window {
		-ms-overflow-style: none;
		scrollbar-width: none;
	}

	.chat-mention {
		background-color: var(--primary55);
		border-radius: 5px;
	}

	.profile-pic-30 {
		width: 30px;
		height: 30px;
		border-radius: 50%;
		text-align: center;
		object-fit: cover;
	}

	.chat-message p {
		display: inline-block;
	}
</style>

<script>
	let socket=io()
	let chatline = document.getElementsByClassName('chat-line')[0]
	let box = document.getElementById('chat-window')
	let textbox = document.getElementById('input-text')
	let icon = document.getElementById('favicon')
	let notifs = 0;
	let scrolled_down = true;
	let focused = true;
	let is_typing = false;
	let alert=true;

	box.scrollTo(0, box.scrollHeight)

	function flash(){
		let title = document.getElementsByTagName('title')[0]
		if (notifs >= 1 && !focused){
			title.innerHTML = `[+${notifs}] Chat`;
			if (alert) {
				icon.href = '/static/assets/images/{{SITE_NAME}}/alert.webp?v=1'
				alert=false;
			}
			else {
				icon.href = '/static/assets/images/{{SITE_NAME}}/icon.webp?v=1012'
				alert=true;
			}
			setTimeout(flash, 500)
		}
		else {
			icon.href = '/static/assets/images/{{SITE_NAME}}/icon.webp?v=1012'
			notifs = 0
			title.innerHTML = 'Chat';
		}
	}


	socket.on('speak', function(json) {
		let text = json['text']
		let text_html = json['text_html']

		if (text_html.includes('<a href="/id/{{v.id}}">')){
			chatline.classList.add('chat-mention');
		}
		else {
			chatline.classList.remove('chat-mention');
		};

		notifs = notifs + 1;
		if (notifs == 1) {
			setTimeout(flash, 500);
		}

		scrolled_down = (box.scrollHeight - box.scrollTop <= window.innerHeight-109)
		document.getElementsByClassName('desktop-avatar')[0].src = json['avatar']
		document.getElementsByClassName('mobile-avatar')[0].src = json['avatar']
		document.getElementsByClassName('userlink')[0].href = '/@' + json['username']
		document.getElementsByClassName('userlink')[0].innerHTML = json['username']
		document.getElementsByClassName('userlink')[0].style.color = '#' + json['namecolor']
		document.getElementsByClassName('quote-btn')[0].onclick = function() {quote(text)}
		document.getElementsByClassName('chat-message')[0].innerHTML = text_html
		document.getElementById('chat-text').append(document.getElementsByClassName('chat-line')[0].cloneNode(true))
		if (scrolled_down) box.scrollTo(0, box.scrollHeight)
	})


	function send() {
		text = textbox.value.trim()
		if (text)
		{
			socket.emit('speak', text);
			textbox.value = ''
			textbox.style.height = '40px'
			is_typing = false
			socket.emit('typing', false);
		}
	}

	function quote(text) {
		textbox.style.height = '80px'
		textbox.value = '> ' + text + '\n\n'
		textbox.focus()
	}

	textbox.addEventListener("keyup", function(e) {
		if (!e.shiftKey && e.key === 'Enter') {
			e.preventDefault();
			send()
		}
	})

	socket.on('online', function(data){
		document.getElementsByClassName('board-chat-count')[0].innerHTML = data.length
		let online = ''
		for (const u of data)
			online += `<li><a href="/@${u}" class="text-lg">${u}</a></li>`
		document.getElementById('online').innerHTML = online
	})

	window.addEventListener('blur', function(){
		focused=false
	})
	window.addEventListener('focus', function(){
		focused=true
	})


	textbox.addEventListener("input", function() {
		text = textbox.value
		if (!text && is_typing==true){
			is_typing=false;
			socket.emit('typing', false);
		}
		else if (text && is_typing==false) {
			is_typing=true;
			socket.emit('typing', true);
		}
	})


	socket.on('typing', function (users){
		if (users.length==0){
			document.getElementById('typing-indicator').innerHTML = '';
			document.getElementById('loading-indicator').classList.add('d-none');
		}
		else if (users.length==1){
			document.getElementById('typing-indicator').innerHTML = '<b>'+users[0]+"</b> is typing...";
			document.getElementById('loading-indicator').classList.remove('d-none');
		}
		else if (users.length==2){
			document.getElementById('typing-indicator').innerHTML = '<b>'+users[0]+"</b> and <b>"+users[1]+"</b> are typing...";
			document.getElementById('loading-indicator').classList.remove('d-none');
		}
		else if (users.length==3){
			document.getElementById('typing-indicator').innerHTML = '<b>'+users[0]+"</b>, <b>"+users[1]+"</b>, and <b>"+users[2]+"</b> are typing...";
			document.getElementById('loading-indicator').classList.remove('d-none');
		}
		else if (users.length>=4){
			more=users.length-3
			document.getElementById('typing-indicator').innerHTML = '<b>'+users[0]+"</b>, <b>"+users[1]+"</b>, <b>"+users[2]+"</b> and "+more.toString()+" more are typing...";
			document.getElementById('loading-indicator').classList.remove('d-none');
		}
	})
</script>

{% include "emoji_modal.html" %}

{% endblock %}